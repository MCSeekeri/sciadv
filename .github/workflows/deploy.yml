name: Deploy
on: [push, repository_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 载入文件
        uses: actions/checkout@v3
        with:
          submodules: true # Checkout private submodules(themes or something else). 当有子模块时切换分支？
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Node.js 16.x
        uses: actions/setup-node@main
        with:
          node-version: 16
          registry-url: https://registry.npmjs.org

      - name: Setup Python 3.7
        uses: actions/setup-python@v2
        with:
          python-version: "3.7"
          architecture: "x64"

      - name: 设置Hexo环境
        env:
          ACTION_DEPLOY_KEY: ${{ secrets.ACTION_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh/
          echo "$ACTION_DEPLOY_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com e.coding.net gitee.com >> ~/.ssh/known_hosts
          git config --global user.name 'MCSeekeri' 
          git config --global user.email 'mcseekeri@github.com'
          git ls-files -z | while read -d '' path; do touch -d $(git log -1 --format="@%ct" "$path") "$path"; done
          npm i -g hexo-cli yarn
          yarn

      - name: 生成文件
        run: |
          hexo generate && gulp
          python ./.github/cache.py
          
      - name: NPM Publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          node ./.github/npm-version-bump.js
          cd public
          rm ./sw.js
          npm publish --access public
          rm -rf ./package.json
          cd ..
      
      - name: Refresh NPM Cache
        run: |
          curl -X PUT "https://registry.npmmirror.com/MCSeekeri/sciadv/sync?publish=false&nodeps=false"

      - name: 部署页面并提交搜索引擎
        env:
          BAIDU_TOKEN: ${{ secrets.BAIDU_TOKEN }}
          BING_TOKEN: ${{ secrets.BING_TOKEN }}
          GOOGLE_TOKEN: ${{ secrets.GOOGLE_TOKEN }}
        run: |
          echo "$GOOGLE_TOKEN" | tr -d '\r' >> $GITHUB_WORKSPACE/push.json
          sed -i s/1.0.changethis/$(npm view @mcseekeri/sciadv version)/g $GITHUB_WORKSPACE/source/sw.js 
          cp source/sw.js public/
          gulp && hexo deploy

      # - name: 部署到Cloudflare Workers
      #   uses: cloudflare/wrangler-action@1.3.0
      #   with:
      #     apiToken: ${{ secrets.CF_WORKERS_TOKEN }}